path = require 'path'
fs = require 'fs'

mongoose = require 'mongoose'
mongo = require './mongo'
middleware = require './middleware'

exports.settings = settings = {}
exports.middleware = middleware.func



getSchema = exports.getSchema = (name) ->
	return mongo.getSchema name

createModel = exports.createModel = (name, schema) ->
	model = mongo.createModel name, schema
	middleware.addModel model

loadModels = exports.loadModels = (folder) ->
	load = (dir) ->
		files = fs.readdirSync dir
		for file in files
			do (file) ->
				file = path.join dir, file
				if !fs.statSync(file).isDirectory()
					if path.extname(file) == settings.modelExtension
						obj = require file
						name = Object.keys(obj)[0]
						schema = obj[name]
						createModel name, schema
				else
					#it's directory
					load file

	load folder

exports.setup = (options) ->
	settings.modelExtension = options.modelExtension || '.js'
	settings.modelsFolder = options.modelsFolder || null
	settings.namespace = options.namespace || null
	if settings.modelsFolder
		loadModels settings.modelsFolder



exports.connect = (connectionString) ->
	con = mongoose.connection
	mongoose.connect connectionString,
		server:
			socketOptions:
				keepAlive: 1

	mongoose.connection.on 'connected', ->
		console.log 'MongoDB connected'

	mongoose.connection.on 'disconnected', ->
		console.log 'MongoDB disconnected'

	mongoose.connection.on 'error', (err) ->
		console.log 'MongoDB returned with error ' + err

	return con

