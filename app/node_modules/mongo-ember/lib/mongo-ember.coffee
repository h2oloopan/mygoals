path = require 'path'
fs = require 'fs'

mongoose = require 'mongoose'
mongo = require './mongo'
js = require './js'
api = require './api'
auth = require './auth'

settings = exports.settings = {}

me = module.exports = 
	getSchema: (name) ->
		return mongo.getSchema name
	createModel: (name, schema) ->
		model = mongo.createModel name, schema
		js.addModel model
	loadModels: (folder) ->
		load = (dir) ->
			files = fs.readdirSync dir
			for file in files
				do (file) ->
					file = path.join dir, file
					if !fs.statSync(file).isDirectory()
						if path.extname(file) == settings.modelExtension
							obj = require file
							name = Object.keys(obj)[0]
							schema = obj[name].schema
							me.createModel name, schema
					else
						#it's directory
						load file
		load folder
	connect: (connectionString, cb) ->
		mongoose.connect connectionString,
			server:
				socketOptions:
					keepAlive: 1

		mongoose.connection.on 'connected', ->
			console.log 'MongoDB connected'
			if cb? then cb()

		mongoose.connection.on 'disconnected', ->
			console.log 'MongoDB disconnected'

		mongoose.connection.on 'error', (err) ->
			console.log 'MongoDB returned with error ' + err

	setup: (options) ->
		settings.modelExtension = options.modelExtension || '.js'
		settings.modelsFolder = options.modelsFolder || null
		settings.namespace = options.namespace || null
		settings.connectionString = options.connectionString || null
		settings.primaryKey = options.primaryKey || '_id'
		settings.mePath = options.mePath || '/js/me.js'
		settings.userModel = options.userModel || 'User'
		settings.usernameField = options.usernameField || 'username'
		settings.passwordField = options.passwordField || 'password'
		settings.authPath = options.authPath || '/api/auth'
		settings.uglify = options.uglify || false

		#validations
		settings.validations = options.validations || {}
		settings.validations.requiredMessage = '{PATH} cannot be empty'
		settings.validations.matchMessage = 'Invalid {PATH}'

		@loadModels settings.modelsFolder
		return @
	init: (app, cb) ->
		js.bind app
		api.bind app
		
		#authentication
		auth.bind app
		app.use auth.middleware
		#override users api
		
		if settings.connectionString?
			@connect settings.connectionString, cb

	

