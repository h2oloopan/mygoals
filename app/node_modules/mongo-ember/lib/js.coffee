me = require './mongo-ember'

toSkip = [
	'__v'
]

toUnderscore = [
	'model'
]

typeMap =
	'String': 'string'
	'ObjectID': 'string'

toSend = 'models = {}; '

createModel = (schema) ->
	js = ''
	keys = Object.keys schema
	count = 1
	for key in keys
		definition = schema[key]
		if toUnderscore.indexOf(key) >= 0 then js += '_'
			
		js += key + ': DS.attr("' + typeMap[definition.instance] + '")'

		if count < keys.length then js += ', '
		count++




	return js

createAdapter = (schema) ->
	return (if me.settings.namespace then 'namespace: "' + me.settings.namespace + '"' else '')

createSerializer = (schema) ->
	js = ''

	if me.settings.primaryKey != 'id' then js += 'primaryKey: "' + me.settings.primaryKey + '"'

	return js

createJs = (name, schema) ->
	console.log name
	console.log schema
	js = '
			models["' + name + '"] = DS.Model.extend({
				' + createModel(schema) + '
			});

			adapters["' + name + '"] = DS.RESTAdapter.extend({
				' + createAdapter(schema) + '
			});

			serializers["' + name + '"] = DS.RESTSerializer.extend({
				' + createSerializer(schema) + ' 
			});
		 '
	return js


js = module.exports = 
	addModel: (model) ->
		name = model.modelName
		paths = model.schema.paths
		keys = Object.keys paths
		for key in keys
			if toSkip.indexOf(key) >= 0
				delete paths[key]
			
		js = createJs name, paths
		if toSend?
			toSend += js
		else
			toSend = js
		console.log toSend
		

	middleware: (req, res, next) ->
		#routing
		next()